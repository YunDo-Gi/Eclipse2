using Oculus.Interaction.HandGrab;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class CarController : MonoBehaviour
{
    //???? ?? ???? ?????? check???? ?????? ????
    public delegate void CarReachedEnd(GameObject car);
    public event CarReachedEnd OnCarReachedEnd;

    private float roadEndZ;

    //???????? ???? ???? ???? ?????? ???? ????
    public float stopDistance = 4f; //???????? ?????? ??????

    public bool canMove = true;
    private TrafficLight trafficLight;
    private AudioSource audioSource;
    
    private void Start()
    {
        trafficLight = FindObjectOfType<TrafficLight>();
        // 오디오 소스 가져오기  
        audioSource = GetComponent<AudioSource>();
        audioSource.playOnAwake = false;
    }

    public void Initialize(float endZ)
    {
        roadEndZ = endZ;
    }

  
    void Update()
    {
        // ???????? ???? ???? ???????? ?????? ????
        // ???????? ???? ???? ???? 2?????? ????, roadEndZ ?????? ?????? ?????? ???? event ????
        if ((transform.position.z <= roadEndZ && roadEndZ < 0) || (transform.position.z >= roadEndZ && roadEndZ >= 0))
        {
            OnCarReachedEnd?.Invoke(gameObject);
        }


        //???????? ???? ?????? ???? ????
        //?????? crosswalk?? tag???? ?? ?????? ray?? ???? ???????? ???????? ?????? ??????, ?? ?? ???? ???? ???????? ???? ?????? ???? ???????? ??????
        bool redFlag;
        if (roadEndZ < 0)
        {
            redFlag = trafficLight.currentColor == TrafficLight.LightColor.Red && (transform.position.z <= 8 && transform.position.z >= 2);
        }
        else
        {
            redFlag = trafficLight.currentColor == TrafficLight.LightColor.Red && (transform.position.z <= 2 && transform.position.z >= -4);
        }
        

        //?????? ?????? ???? ???? ????
        if (canMove)
        {
            //?????? ???? ???? ?????? ???????? stop
            if (redFlag || IsNearObstacle())
            {
                // 일단 차 멈춤 
                StopCar();

                // 사람과 가까이 있으면 경적 소리 on
                if (IsNearObstacle())
                {
                   // 오큘러스 collider 추가 -> 태그 달아서 인식 
                   
                   audioSource.playOnAwake = true;

                }
            
                // 신호등 red duration 얼마 안 남으면 경적 소리 on 
                if (trafficLight.redDuration <= 3f)
                {
                    audioSource.playOnAwake = true;
                }

            }
        }
        else
        {
            //???????? ?????? ?????????? ?????? ?????? move
            if (!(redFlag || IsNearObstacle()))
            {
                MoveCar();
            }
        }
    }

    void StopCar()
    {
        canMove = false;
    }

    void MoveCar()
    {
        canMove = true;
    }

    bool IsNearObstacle()
    {
        // ???????? ?????? Ray?? ???? ???????? ?????? ????
        RaycastHit hit;
        if (Physics.Raycast(transform.position, transform.forward, out hit, stopDistance))
        {
            // ?????? ?????? ?????? true ????
            return true;
        }

        // ?????? ?????? ?????? false ????
        return false;
    }
}